<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Poppins:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap"
        rel="stylesheet">

    <!-- My Style Sheet -->
    <link rel="stylesheet" href="./Fee_Management.css">

    <!-- Fond Awesome Link -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"
        integrity="sha512-SnH5WK+bZxgPHs44uWIX+LLJAJ9/2PkPKZ5QiAj6Ta86w+fsb2TkcmfRyVX3pBnMFcV7oQPJkl9QevSCWr3W6A=="
        crossorigin="anonymous" referrerpolicy="no-referrer" />

    <!-- Bootstrap cdn -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">

    <link rel="icon" href="../image/icon.jpg">

    <title>Student Registration</title>
</head>

<body>
    <!-- Navebar -->
    <nav class="navbar px-5">
        <div class="logo">
            <img src="../image/icon-removebg-preview.png" alt="A-Z LOGO">
            <h1> Coding Academy</h1>
        </div>
        <div class="navebar-menu-toggle">
            <i class="fa-solid fa-bars"></i>
        </div>
    </nav>

    <!-- Side Navebar -->
     <div class="side">

         <div class="side-navebar">
             <p>
                 <i class="fa-solid fa-xmark"></i>
             </p>
             <ul class="side-navebar-links">
                 <li class="side-navebar-link"><a href="../Student_Registration/Student_Registration.html">REGISTER</a>
                 </li>
                 <li class="side-navebar-link"><a href="../Fee_Managment/Fee_Management.html">PAYMENT</a></li>
                 <li class="side-navebar-link"><a href="../Course_offering/Course_offering.html">COURSE OFFERINGS</a>
                 </li>
                 <li class="side-navebar-link"><a href="../05_Report/report.html">REPORT</a></li>
                 <li class="side-navebar-link logout"><a href="#" id="logoutButton">Logout</a></li>
             </ul>
         </div>
     </div>


     <!-- Form -->
    <div id="main-container">
        <div id="sub-container" class="mt-5">
            <div id="fee-management" class=" px-5">
                <div class="d-flex justify-content-between align-items-top mb-5">
                    <h2>Fee Management</h2>
                    <button type="button"  class="btn btn-outline-secondary text-secondary-emphasis d-flex justify-content-end align-items-top" data-bs-toggle="modal" data-bs-target="#exampleModal">Details <i class="fa fa-info-circle align-items-center" aria-hidden="true"></i></button>
                </div>

                <form id="fee-management-form">
                    <table>
                        <tr class="mt-4">
                            <td><label for="nic">NIC Number</label></td>
                            <td><input type="text" id="nic" name="nic" required></td>
                        </tr>
                        <tr class="mt-4">
                            <td><label for="followedCourse">Following Course</label></td>
                            <td><select class="mt-2"  id="followedCourse" >
                                <option selected>Select your pay course</option>
                              </select></td>
                        </tr>

                        <tr class="mt-4">
                            <td><label for="total-course-fee">Total Course Fee</label></td>
                            <td><p id="total-course-fee">0 Rs</p></td>
                        </tr>

                        <tr class="mt-4">
                            <td><label for="payment-plan">Payment Plans</label></td>
                            <td>
                                <select name="payment-plan" id="payment-plan">
                                    <option >payment-plan</option>
                                    <option value="fullpayment">Full Payment</option>
                                    <option value="installment">Installment</option>
                                </select>
                            </td>
                        </tr>

                        <tr id="if-full-payment" class="mt-4" >
                            <td><label for="email">Total Amount</label></td>
                            <td><p id="total-amount">0 Rs</p></td>
                        </tr>

                        <tr id="if-installment" class="mt-4">
                            <td><label for="phone">Installments</label></td>
                            <td><p id="installment-amount">0 Rs</p></td>
                        </tr>
                       
                    </table>
                     
                    <div id="button-container" class="d-grid col-6 mx-auto mt-5">
                        <button type="submit" class="btn btn-success">Pay</button>
                    </div>

                </form>

                <div>
                    <p id="fee-management-message"></p>
                </div>

            </div>
        </div>
    </div>
  
 <!-- Payment details modal -->
  <div class="modal fade" id="exampleModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" style="width: 100%;">
      <div class="modal-content">
        <div class="modal-header">
          <h1 class="modal-title fs-5" id="exampleModalLabel">Payment details</h1>
          <div >
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            <button type="button" class="btn btn-primary">Save changes</button>
          </div>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
            <div id="table-1">
                <div id="table-container">
                    <table id="payment-details-table" class="table">
                        <thead>
                            <tr>
                                <th>Payment ID</th><th>Course Fee</th><th>Installment Amount</th><th>Payment Paid</th><th>Payment Due</th>
                            </tr>
                        </thead>
                        <tbody id="table-body-installment">
    
                        </tbody>
                    </table>
                </div>
            </div>
            
            <div id="table-2">
                <div id="table-container" >
                    <table id="payment-details-table" class="payment-details-table-2 table">
                        <thead>
                            <tr>
                                <th>Payment ID</th><th>NIC Number</th><th>Full Name</th><th>Course Fee</th><th>Payment Paid</th>
                            </tr>
                        </thead>
                        <tbody id="table-body-fullpayment">
    
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        
      </div>
    </div>
  </div>






    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
        crossorigin="anonymous"></script>
    <script src="./Fee_Management.js"></script>
    <script>
        //Site Navebar
const toggle = document.querySelector(".fa-bars")
const toggleClose = document.querySelector(".fa-xmark")
const sideNavebar = document.querySelector(".side-navebar")

toggle.addEventListener("click" ,function(){
    sideNavebar.style.right = "0"
})

toggleClose.addEventListener("click" , function(){
    sideNavebar.style.right = "-60%"
})




let students  = [];
let courses = [];
let courseEnrollData = [];
let InstallmentDetails  = [];
let FullpaymentDetails  = [];

const GetAllStudentsURL = 'http://localhost:5251/api/Student/Get-All-Students';
//Fetch Students Data from Database
async function GetAllStudents(){
    fetch(GetAllStudentsURL).then((response) => {
        return response.json();
    }).then((data) => {
        students = data;
    })
};
GetAllStudents()


const GetAllCoursesURL = 'http://localhost:5251/api/Course/Get-All-Courses';
//Fetch Students Data from Database
async function GetAllCourses(){
    fetch(GetAllCoursesURL).then((response) => {
        return response.json();
    }).then((data) => {
        courses = data;
    })
};
GetAllCourses()

const GetAllCourseEnrollURL = 'http://localhost:5251/api/CourseEnroll/Get-All-Enroll-Data';
//Fetch CourseEnrollData Data from Database
async function GetAllCourseEnrollData(){
    fetch(GetAllCourseEnrollURL).then((response) => {
        return response.json();
    }).then((data) => {
        courseEnrollData = data;
    })
};
GetAllCourseEnrollData()

const GetAllInstallmentsURL = 'http://localhost:5251/api/Installment/Get-All-Installments';
//Fetch Installments Data from Database
async function GetAllInstallments(){
    fetch(GetAllInstallmentsURL).then((response) => {
        return response.json();
    }).then((data) => {
        InstallmentDetails = data;
        displayInstallmentPaymentTable()
    })
    
};
GetAllInstallments()

const GetAllFullPaymentURL = 'http://localhost:5251/api/FullPayment/Get-All-FullPayments';
//Fetch Fullpayments Data from Database
async function GetAllFullPayments(){
    fetch(GetAllFullPaymentURL).then((response) => {
        return response.json();
    }).then((data) => {
        FullpaymentDetails = data;
        displayFullPaymentTable()
    })
};
GetAllFullPayments()

const AddFullPaymentURL = 'http://localhost:5251/api/FullPayment/Add-FullPayment';
//Add FullPayment data in Database
async function AddFullPayment(FullPaymentData){
    await fetch(AddFullPaymentURL, {
        method: "POST",
        headers: {
            "Content-Type": "application/json"
        },
        body: JSON.stringify(FullPaymentData)
    });
    GetAllFullPayments()
    displayFullPaymentTable()
};


const UpdateStatusURL = 'http://localhost:5251/api/CourseEnroll/Update-Status';
//Update CourseEnroll Status
async function UpdateStatus(CourseEnrollId , Status){
    await fetch(`${UpdateStatusURL}/${CourseEnrollId}/${Status}`,{
        method:"PUT",
        headers:{
            "Content-Type":"application/json"
        },
    });
    GetAllCourseEnrollData()
}

const UpdatePaymentIdURL = 'http://localhost:5251/api/CourseEnroll/Add-payment-Id';
//Update CourseEnroll PaymentId
async function UpdatePaymentId(CourseEnrollId , InstallmentId , FullPaymentId){
    await fetch(`${UpdatePaymentIdURL}/${CourseEnrollId}/${InstallmentId}/${FullPaymentId}`,{
        method:"PUT",
        headers:{
            "Content-Type":"application/json"
        },
    });
    GetAllCourseEnrollData()
}

const UpdateInstallmentURL = 'http://localhost:5251/api/Installment/Update-Installment';
//Update Installments
async function UpdateInstallment(installmentId , paidAmount){
    await fetch(`${UpdateInstallmentURL}/${installmentId}/${paidAmount}`,{
        method:"PUT",
        headers:{
            "Content-Type":"application/json"
        },
    });
    GetAllInstallments()
}

const AddInstallmentURL = 'http://localhost:5251/api/Installment/Add-installment';
//Add Stud
async function AddInstallment(InstallmentData){
    await fetch(AddInstallmentURL, {
        method: "POST",
        headers: {
            "Content-Type": "application/json"
        },
        body: JSON.stringify(InstallmentData)
    });
    GetAllInstallments();
    displayInstallmentPaymentTable();
};


// let totalAmount = 0;
// let installmentAmount = 0;

// document.getElementById('nic').addEventListener("keyup" , () =>{
//     const nic = document.getElementById('nic').value.trim();
//     const student = students.find((student) => student.nic == nic);
            
//     if(student){
//         if(student.courseEnrollId != 0){
//             const CourseEnrollDetail = courseEnrollData.find(c => c.id === student.courseEnrollId);
//             const CourseDetails = courses.find(c => c.id == CourseEnrollDetail.courseId)

//             if(CourseEnrollDetail != null){
//                 document.getElementById('fee-management-message').textContent = student.fullName;
//                 document.getElementById('fee-management-message').style.color = "green";
    
//                 courses.forEach(element => {
//                     if(element.courseName == CourseDetails.courseName && element.level == CourseDetails.level){
//                         document.getElementById('total-course-fee').textContent = `${element.totalFee} Rs`;
//                         document.getElementById('total-amount').textContent = `${element.totalFee} Rs`;
//                         if(CourseEnrollDetail.duration == "3"){
//                             installmentAmount = element.totalFee / 3;
//                             document.getElementById('installment-amount').textContent = `${installmentAmount} Rs / Month`
//                         }else if(CourseEnrollDetail.duration == "6"){
//                                 installmentAmount = element.totalFee / 6;
//                                 document.getElementById('installment-amount').textContent = `${installmentAmount} Rs / Month`
//                         }
//                         totalAmount = element.totalFee;
//                     }
//                 });
    
//             }

//         }else{
//             document.getElementById('fee-management-message').textContent = `${student.fullName} didnt select a course`;
//             document.getElementById('fee-management-message').style.color = "red";
//             document.getElementById('total-course-fee').textContent = `0 Rs`;
//             document.getElementById('total-amount').textContent = `0 Rs`;
//             document.getElementById('installment-amount').textContent = `0 Rs`;
//         }

//     }else{
//         document.getElementById('fee-management-message').textContent = "Student not found";
//         document.getElementById('fee-management-message').style.color = "red";
//     }

// });


let totalAmount = 0;
    let installmentAmount = 0;

    // When the NIC is entered, look for the student
    document.getElementById('nic').addEventListener("keyup", () => {
        const nic = document.getElementById('nic').value.trim();
        const student = students.find((student) => student.nic == nic);
        
        const followedCourseDropdown = document.getElementById('followedCourse');
        const feeManagementMessage = document.getElementById('fee-management-message');
        
        if (student) {
            if (student.courseEnrollId != 0) {
                // If the student is enrolled in a course, show the courses in the dropdown
                const CourseEnrollDetail = courseEnrollData.find(c => c.id === student.courseEnrollId);
                const CourseDetails = courses.find(c => c.id == CourseEnrollDetail.courseId);

                if (CourseEnrollDetail != null) {
                    // Display student name and set color to green
                    feeManagementMessage.textContent = student.fullName;
                    feeManagementMessage.style.color = "green";

                    // Populate the dropdown with all available courses
                    followedCourseDropdown.innerHTML = '<option selected>Select your pay course</option>'; // Reset options

                    // Add all courses to the dropdown
                    courses.forEach(course => {
                        let option = document.createElement("option");
                        option.value = course.id;
                        option.textContent = `${course.courseName} (${course.level})`;
                        followedCourseDropdown.appendChild(option);
                    });

                }
            } else {
                // If the student is not enrolled in any course
                feeManagementMessage.textContent = `${student.fullName} has not followed any course`;
                feeManagementMessage.style.color = "red";

                // Show message in the dropdown
                followedCourseDropdown.innerHTML = '<option selected>Student has not followed any course</option>';
                document.getElementById('total-course-fee').textContent = `0 Rs`;
                document.getElementById('total-amount').textContent = `0 Rs`;
                document.getElementById('installment-amount').textContent = `0 Rs`;
            }
        } else {
            // If the student with the entered NIC does not exist
            feeManagementMessage.textContent = "Student not found";
            feeManagementMessage.style.color = "red";

            // Reset dropdown options
            followedCourseDropdown.innerHTML = '<option selected>Select your pay course</option>';
            document.getElementById('total-course-fee').textContent = `0 Rs`;
            document.getElementById('total-amount').textContent = `0 Rs`;
            document.getElementById('installment-amount').textContent = `0 Rs`;
        }
    });

    // When a course is selected, update the course fee and installment info
    document.getElementById('followedCourse').addEventListener('change', function () {
        const selectedCourseId = this.value;

        // If "Student has not followed any course" is displayed, exit the function
        if (selectedCourseId === "Student has not followed any course") return;

        const selectedCourse = courses.find(course => course.id == selectedCourseId);

        if (selectedCourse) {
            document.getElementById('total-course-fee').textContent = `${selectedCourse.totalFee} Rs`;
            totalAmount = selectedCourse.totalFee;

            // Calculate installment amounts based on course duration
            if (selectedCourse.duration == "3") {
                installmentAmount = totalAmount / 3;
                document.getElementById('installment-amount').textContent = `${installmentAmount} Rs / Month`;
            } else if (selectedCourse.duration == "6") {
                installmentAmount = totalAmount / 6;
                document.getElementById('installment-amount').textContent = `${installmentAmount} Rs / Month`;
            }
        }
    });

    </script>
</body>

</html>